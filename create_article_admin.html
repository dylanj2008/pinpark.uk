<!-- create_article_admin.html -->
<!DOCTYPE HTML>
<!--
	Prologue by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>PinPark</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

		<!-- âœ… Tab icon -->
		<link rel="icon" type="image/png" href="pinparklogo.png" />

		<link rel="stylesheet" href="assets/css/main.css" />

		<style>
			/* âœ… Hide admin page until admin is verified */
			html { visibility: hidden; }

			/* âœ… Make the blue cover part exactly 60px tall */
			#create.cover {
				height: 60px !important;
				min-height: 60px !important;
				padding: 0 !important;
			}
			#create.cover > .container {
				padding: 0 !important;
				margin: 0 !important;
			}
			#create.cover header,
			#create.cover h2,
			#create.cover p {
				margin: 0 !important;
				padding: 0 !important;
			}

			/* âœ… PinPark hero tint */
			#create.cover:before,
			#create:before {
				background: linear-gradient(
					135deg,
					rgba(0, 173, 238, 0.78) 0%,
					rgba(255, 255, 255, 0.35) 50%,
					rgba(0, 138, 205, 0.78) 100%
				) !important;
			}

			/* âœ… PinPark hero tint overlay */
			#create.cover {
				position: relative;
				overflow: hidden;
			}

			#create.cover::after {
				content: "";
				position: absolute;
				inset: 0;
				pointer-events: none;
				z-index: 0;

				background:
					radial-gradient(circle at 0% 100%,
						rgba(0, 173, 238, 0.8) 0%,
						rgba(0, 173, 238, 0.8) 22%,
						rgba(0, 173, 238, 0.6) 30%,
						rgba(0, 173, 238, 0.3) 38%,
						rgba(0, 173, 238, 0) 46.2%
					),
					radial-gradient(circle at 100% 0%,
						rgba(255, 255, 255, 0.10) 0%,
						rgba(255, 255, 255, 0.10) 16%,
						rgba(255, 255, 255, 0.07) 23%,
						rgba(255, 255, 255, 0.04) 30%,
						rgba(255, 255, 255, 0.02) 36%,
						rgba(255, 255, 255, 0) 41.8%
					),
					linear-gradient(
						135deg,
						rgba(0, 138, 205, 0.75) 0%,
						rgba(0, 138, 205, 0.75) 100%
					);
			}

			/* âœ… keep your hero content above the tint */
			#create.cover > .container {
				position: relative;
				z-index: 1;
			}

			/* âœ… Make PinPark logo 25% smaller total */
			#logo .image img {
				width: 75%;
				height: auto;
				transform: translateY(-10px);
			}

			/* âœ… Center the PinPark logo horizontally in the sidebar column */
			#logo {
				text-align: center;
			}
			#logo .image {
				display: inline-block;
			}
			#logo .image img {
				display: block;
				margin: 0 auto;
			}

			/* âœ… Ensure left nav icons visibly highlight when active */
			#nav ul li a.active span.icon:before,
			#nav ul li a.active-locked span.icon:before {
				color: #fff !important;
			}
			#nav ul li a.active,
			#nav ul li a.active-locked {
				color: #fff !important;
			}

			/* âœ… Smooth fade for active tab highlight (0.1s in/out, no flash) */
			#nav ul li a,
			#nav ul li a:before,
			#nav ul li a:after,
			#nav ul li a span.icon:before {
				transition:
					background-color 0.1s ease,
					color 0.1s ease,
					opacity 0.1s ease,
					border-color 0.1s ease;
			}

			/* âœ… Position page content like terms.html (strip + logo + heading + paragraph) */
			#main .pinpark-under-strip {
				margin-top: 80px !important;
				text-align: center;
			}
			#main .pinpark-under-strip img {
				max-width: 260px;
				width: 60%;
				height: auto;
				display: inline-block;
			}

			#main .pinpark-under-strip .articles-under-logo {
				margin-top: 0 !important;
				margin-bottom: 80px !important;
			}
			#main .pinpark-under-strip .articles-under-logo h2 {
				margin: 0 !important;
			}

			/* âœ… Form area: match paragraph padding style */
			#main .pinpark-under-strip .articles-paragraph {
				margin-top: 0 !important;
				padding-left: 30px !important;
				padding-right: 30px !important;
				box-sizing: border-box;
				text-align: left !important;
				max-width: 900px;
				margin-left: auto;
				margin-right: auto;
			}

			/* âœ… Bullet toolbar for textareas */
			.bullet-wrapper {
				display: flex;
				flex-direction: column;
				align-items: flex-end;
				gap: 6px;
			}

			.bullet-toolbar {
				align-self: flex-end;
			}

			.bullet-btn {
				border-radius: 999px;
				border: 1px solid rgba(0,0,0,0.12);
				background: rgba(0,0,0,0.04);
				padding: 4px 10px;
				font-size: 0.9em;
				cursor: pointer;
			}

			.bullet-btn:hover {
				background: rgba(0,0,0,0.08);
			}

			/* âœ… Hero image box: now visually matches the big smooth blue hero look */
			.hero-drop {
				width: 100%;
				max-width: 900px;
				height: 180px;
				margin: 0 auto;

				border-radius: 14px;
				border: 1px solid rgba(0, 0, 0, 0.12);

				display: flex;
				align-items: center;
				justify-content: center;

				box-sizing: border-box;
				cursor: pointer;
				user-select: none;

				position: relative;
				overflow: hidden;

				/* Base gradient (sits under the tints) */
				background: linear-gradient(135deg, #00ADEE 0%, #008ACD 100%);

				/* uploaded image goes here (set by JS) */
				background-size: cover;
				background-position: center;
				background-repeat: no-repeat;
			}

			/* âœ… Apply the same tint + circles as the hero / mock-hero */
			.hero-drop::before {
				content: "";
				position: absolute;
				inset: 0;
				pointer-events: none;
				z-index: 0;
				background: linear-gradient(
					135deg,
					rgba(0, 173, 238, 0.78) 0%,
					rgba(255, 255, 255, 0.35) 50%,
					rgba(0, 138, 205, 0.78) 100%
				);
			}
			.hero-drop::after {
				content: "";
				position: absolute;
				inset: 0;
				pointer-events: none;
				z-index: 0;
				background:
					radial-gradient(circle at 0% 100%,
						rgba(0, 173, 238, 0.8) 0%,
						rgba(0, 173, 238, 0.8) 22%,
						rgba(0, 173, 238, 0.6) 30%,
						rgba(0, 173, 238, 0.3) 38%,
						rgba(0, 173, 238, 0) 46.2%
					),
					radial-gradient(circle at 100% 0%,
						rgba(255, 255, 255, 0.10) 0%,
						rgba(255, 255, 255, 0.10) 16%,
						rgba(255, 255, 255, 0.07) 23%,
						rgba(255, 255, 255, 0.04) 30%,
						rgba(255, 255, 255, 0.02) 36%,
						rgba(255, 255, 255, 0) 41.8%
					),
					linear-gradient(
						135deg,
						rgba(0, 138, 205, 0.75) 0%,
						rgba(0, 138, 205, 0.75) 100%
					);
			}

			/* Title always shown on hero */
			.hero-title {
				position: relative;
				z-index: 1;
				color: #fff;
				font-size: 1.35em;
				line-height: 1.15;
				text-align: center;
				padding: 0 20px;
				text-shadow: 0 4px 14px rgba(0,0,0,0.22);
				max-width: 90%;
				word-break: break-word;
			}

			.hero-drop.drag {
				border-color: rgba(0, 138, 205, 0.45);
			}

			/* âœ… Add-section button (full width, "+" label) */
			.add-section-wrap {
				max-width: 900px;
				margin: 14px auto 0;
				padding: 0 30px;
				box-sizing: border-box;
			}
			.add-section-btn {
				width: 100%;
				display: block;
				border: 1px solid rgba(255,255,255,0);
				border-radius: 14px;
				background: linear-gradient(135deg, #00ADEE 0%, #008ACD 100%);
				color: #fff;
				font-size: 1.6em;
				line-height: 1;
				padding: 16px 0;
				cursor: pointer;
				user-select: none;
				box-shadow: 0 8px 16px rgba(0,0,0,0.08);
			}
			.add-section-btn:hover {
				filter: brightness(0.98);
			}

			/* âœ… Article mockup card (preview) */
			.article-mock {
				max-width: 900px;
				margin: 50px auto 0;
				padding: 0 30px;
				box-sizing: border-box;
				text-align: left;
			}
			.article-mock .mock-card {
				border: 1px solid rgba(0,0,0,0.10);
				border-radius: 14px;
				box-shadow: 0 10px 22px rgba(0,0,0,0.06);
				overflow: hidden;
				background: #fff;
			}
			.article-mock .mock-hero {
				height: 220px;
				position: relative;
				overflow: hidden;
				background-size: cover;
				background-position: center;
				background-repeat: no-repeat;
			}
			/* Default hero tint (matches page top strip tint) */
			.article-mock .mock-hero::before {
				content: "";
				position: absolute;
				inset: 0;
				pointer-events: none;
				z-index: 0;
				background: linear-gradient(
					135deg,
					rgba(0, 173, 238, 0.78) 0%,
					rgba(255, 255, 255, 0.35) 50%,
					rgba(0, 138, 205, 0.78) 100%
				);
			}
			.article-mock .mock-hero::after {
				content: "";
				position: absolute;
				inset: 0;
				pointer-events: none;
				z-index: 0;
				background:
					radial-gradient(circle at 0% 100%,
						rgba(0, 173, 238, 0.8) 0%,
						rgba(0, 173, 238, 0.8) 22%,
						rgba(0, 173, 238, 0.6) 30%,
						rgba(0, 173, 238, 0.3) 38%,
						rgba(0, 173, 238, 0) 46.2%
					),
					radial-gradient(circle at 100% 0%,
						rgba(255, 255, 255, 0.10) 0%,
						rgba(255, 255, 255, 0.10) 16%,
						rgba(255, 255, 255, 0.07) 23%,
						rgba(255, 255, 255, 0.04) 30%,
						rgba(255, 255, 255, 0.02) 36%,
						rgba(255, 255, 255, 0) 41.8%
					),
					linear-gradient(
						135deg,
						rgba(0, 138, 205, 0.75) 0%,
						rgba(0, 138, 205, 0.75) 100%
					);
			}
			.article-mock .mock-body {
				padding: 22px 22px 20px;
			}

			/* âœ… NEW: title + date on SAME Y axis */
			.article-mock .mock-header-row {
				display: flex;
				align-items: center; /* same vertical axis */
				justify-content: space-between;
				gap: 16px;
				flex-wrap: wrap;
				margin: 0 0 14px 0;
			}
			.article-mock .mock-header-title {
				margin: 0;
				font-size: 1.6em;
				line-height: 1.15;
				color: #000;
				word-break: break-word;
			}
			.article-mock .mock-header-meta {
				margin: 0;
				color: rgba(0,0,0,0.55);
				font-size: 0.9em;
				display: flex;
				align-items: center;
				gap: 10px;
				white-space: nowrap;
			}

			.article-mock .mock-tags {
				display: flex;
				gap: 8px;
				flex-wrap: wrap;
				margin-top: 10px;
			}
			.article-mock .tag-pill {
				border: 1px solid rgba(0,0,0,0.10);
				border-radius: 999px;
				padding: 6px 10px;
				font-size: 0.85em;
				background: rgba(0,0,0,0.03);
				color: rgba(0,0,0,0.7);
			}

			/* âœ… Back button: bottom-left, no bullet, no underline */
			#header .bottom {
				text-align: left !important;
				padding-left: 15px !important;
				padding-bottom: 15px !important;
			}
			#nav-back ul,
			#nav-back ul li {
				list-style: none !important;
				margin: 0 !important;
				padding: 0 !important;
			}

			#back-link {
				text-decoration: none !important;
				border-bottom: 0 !important;
				box-shadow: none !important;
				font-size: 0.8em !important;
			}

			#back-link .icon:before {
				margin-right: 5px !important;
				font-size: 1em !important;
			}

			#nav-back ul li a,
			#nav-back ul li a span.icon:before {
				color: rgba(255, 255, 255, 0.55) !important;
			}
			#nav-back ul li a:hover,
			#nav-back ul li a:hover span.icon:before {
				color: #fff !important;
				text-decoration: none !important;
				border-bottom: 0 !important;
			}

			#nav-back ul li a:before,
			#nav-back ul li a:after {
				background: transparent !important;
				box-shadow: none !important;
				opacity: 0 !important;
			}

			/* âœ… Revert footer bar styling back to default (non-blue, black text) */
			#footer,
			#footer::after {
				background: none !important;
				content: none !important;
			}
			#footer {
				position: static !important;
				overflow: visible !important;
				height: 70px;
				padding: 0 !important;
				display: flex;
				align-items: center;
				justify-content: center;
			}
			#footer .copyright {
				margin: 0 !important;
			}
			#footer,
			#footer * {
				color: #000 !important;
			}
			#footer a {
				color: #000 !important;
				border-bottom-color: rgba(0, 0, 0, 0.35) !important;
			}
			#footer a:hover {
				border-bottom-color: rgba(0, 0, 0, 0.7) !important;
			}

			/* âœ… Center Save/Publish buttons, remove bullets, equal size & stacked */
			.articles-paragraph .actions {
				list-style: none !important;
				padding-left: 0 !important;
				margin: 0 !important;
				display: flex;
				flex-direction: column;
				align-items: center;
				gap: 0.8em;
			}
			.articles-paragraph .actions li {
				list-style: none !important;
				margin: 0;
				padding: 0;
			}
			.articles-paragraph .actions input[type="submit"],
			.articles-paragraph .actions #publish-btn {
				min-width: 180px;
				padding: 0.85em 2.5em;
				line-height: 1;
				display: inline-block;
			}
		</style>
	</head>

	<body class="is-preload">

		<!-- Header -->
		<div id="header">
			<div class="top">
				<div id="logo">
					<span class="image"><img src="pinparklogo.png" alt="PinPark" /></span>
				</div>

				<nav id="nav">
					<ul>
						<li><a href="articles_admin.html?section=current" id="current-link"><span class="icon solid fa-file-alt">Latest Article</span></a></li>
						<li><a href="articles_admin.html?section=other" id="other-link"><span class="icon solid fa-list">Other Articles</span></a></li>
						<li><a href="create_article_admin.html" id="create-link" class="active"><span class="icon solid fa-pen">Create</span></a></li>
					</ul>
				</nav>
			</div>

			<div class="bottom">
				<nav id="nav-back">
					<ul>
						<li><a href="articles_admin.html" id="back-link"><span class="icon solid fa-arrow-left">Back</span></a></li>
					</ul>
				</nav>
			</div>
		</div>

		<!-- Main -->
		<div id="main">
			<!-- âœ… Top strip only -->
			<section id="create" class="one dark cover">
				<div class="container">
					<header></header>
				</div>
			</section>

			<!-- âœ… Positioned like terms.html -->
			<div class="pinpark-under-strip">

				<header class="articles-under-logo"><h2>Create Article</h2></header>

				<div id="hero-drop" class="hero-drop" role="button" tabindex="0" aria-label="Upload hero image">
					<input id="hero-file" type="file" accept="image/*" hidden />
					<div class="hero-title" id="hero-title"></div>
				</div>
				<input type="hidden" name="heroImageDataUrl" id="heroImageDataUrl" value="" />

				<div class="articles-paragraph">
					<!-- âœ… Article template -->
					<form method="post" action="#" style="margin: 0;">
						<div class="row">

							<div class="col-12" style="margin-top: 20px;">
								<input type="text" name="title" placeholder="Title" />
							</div>

							<!-- âœ… optional subheading before first paragraph -->
							<div class="col-12">
								<input type="text" name="subheading_main" placeholder="Subheading (optional)" />
							</div>

							<div class="col-12">
								<div class="bullet-wrapper">
									<div class="bullet-toolbar">
										<button type="button" class="bullet-btn" data-bullet-for="content">â€¢</button>
									</div>
									<textarea name="content" placeholder="Write your article here..." rows="10"></textarea>
								</div>
							</div>

							<!-- âœ… sections container (subheading + paragraph blocks) -->
							<div class="col-12" id="sections-container"></div>

							<!-- âœ… full-width "+" button under the paragraph box -->
							<div class="col-12">
								<button type="button" id="add-section" class="add-section-btn" aria-label="Add new section">+</button>
							</div>

							<div class="col-12">
								<input type="text" name="tags" placeholder="Tags (comma separated) e.g. update, release, roadmap" />
							</div>

							<div class="col-12" style="margin-top: 0.7em;">
								<ul class="actions" style="margin: 0;">
									<li>
										<input
											type="submit"
											value="Save draft"
											style="
												background: linear-gradient(135deg, #00ADEE 0%, #008ACD 100%);
												border-radius: 14px;
												color: #fff;
												border: 1px solid rgba(255,255,255,0);
												box-shadow: 0 5px 11px rgba(0,0,0,0.07);
												text-transform: none;
												letter-spacing: inherit;
											"
										/>
									</li>
									<li>
										<!-- âœ… Publish now actually publishes (handled in module script) -->
										<button
											type="button"
											id="publish-btn"
											class="button"
											style="
												background: linear-gradient(135deg, #00ADEE 0%, #008ACD 100%);
												border-radius: 14px;
												color: #fff;
												border: 1px solid rgba(255,255,255,0);
												box-shadow: 0 5px 11px rgba(0,0,0,0.07);
												text-transform: none;
												letter-spacing: inherit;
											"
										>
											Publish
										</button>
									</li>
								</ul>
							</div>
						</div>
					</form>
				</div>

				<!-- âœ… MOCKUP PREVIEW (how it will look as an actual article) -->
				<div class="article-mock">
					<div class="mock-card">
						<div id="mock-hero" class="mock-hero"></div>

						<div class="mock-body">
							<!-- âœ… Title + date in same row, same Y axis -->
							<div class="mock-header-row">
								<h1 class="mock-header-title" id="mock-title">Your Article Title</h1>
								<div class="mock-header-meta">
									<span id="mock-date">22 Dec 2025</span>
									<span>â€¢</span>
									<span>PinPark</span>
								</div>
							</div>

							<div id="mock-content">
								<p>This is a preview of your article layout. When you publish, your content will flow here with your selected hero image above.</p>
								<p>You can use paragraphs, line breaks, and headings (later) to structure updates, release notes, roadmaps, and announcements.</p>
							</div>

							<div class="mock-tags" id="mock-tags">
								<span class="tag-pill">update</span>
								<span class="tag-pill">release</span>
								<span class="tag-pill">roadmap</span>
							</div>
						</div>
					</div>
				</div>
				<!-- âœ… END MOCKUP PREVIEW -->

			</div>
		</div>

		<div id="footer">
			<ul class="copyright">
				<li>&copy; 2025 PinPark. All rights reserved</li>
			</ul>
		</div>

		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/jquery.scrolly.min.js"></script>
		<script src="assets/js/jquery.scrollex.min.js"></script>
		<script src="assets/js/browser.min.js"></script>
		<script src="assets/js/util.js"></script>
		<script src="assets/js/main.js"></script>

		<script>
			(function () {
				var drop = document.getElementById("hero-drop");
				var fileInput = document.getElementById("hero-file");
				var hidden = document.getElementById("heroImageDataUrl");
				var titleEl = document.getElementById("hero-title");
				var titleInput = document.querySelector('input[name="title"]');

				// âœ… sections
				var sectionsContainer = document.getElementById("sections-container");
				var addSectionBtn = document.getElementById("add-section");

				// âœ… main optional subheading
				var mainSubheadingInput = document.querySelector('input[name="subheading_main"]');

				// âœ… mockup bindings
				var mockHero = document.getElementById("mock-hero");
				var mockTitle = document.getElementById("mock-title");
				var contentInput = document.querySelector('textarea[name="content"]');
				var tagsInput = document.querySelector('input[name="tags"]');
				var mockContent = document.getElementById("mock-content");
				var mockTags = document.getElementById("mock-tags");

				if (!drop || !fileInput || !hidden || !titleEl || !titleInput) return;

				function syncTitle() {
					var t = (titleInput.value || "").trim();
					titleEl.textContent = t;
					if (mockTitle) mockTitle.textContent = t || "Your Article Title";
				}

				function renderCombinedContentForMock() {
					if (!mockContent) return;

					var blocks = [];

					// âœ… optional subheading before first paragraph
					if (mainSubheadingInput) {
						var h0 = (mainSubheadingInput.value || "").trim();
						if (h0) blocks.push("<h3 style=\"margin: 0 0 20px 0; color: #666;\">" + h0 + "</h3>");
					}

					// main content textarea first
					if (contentInput) {
						var rawMain = (contentInput.value || "").trim();
						if (rawMain) {
							rawMain.split(/\n\s*\n/g).map(function (p) { return p.trim(); }).filter(Boolean)
								.forEach(function (p) {
									blocks.push("<p>" + p.replace(/\n/g, "<br>") + "</p>");
								});
						}
					}

					// then each extra section: <h3> + paragraphs
					if (sectionsContainer) {
						var sectionEls = sectionsContainer.querySelectorAll(".pp-section");
						sectionEls.forEach(function (sec) {
							var h = sec.querySelector('input[name^="subheading_"]');
							var t = sec.querySelector('textarea[name^="section_"]');
							var heading = (h && h.value || "").trim();
							var body = (t && t.value || "").trim();

							if (heading) blocks.push("<h3 style=\"margin: 0 0 20px 0; color: #666;\">" + heading + "</h3>");

							if (body) {
								body.split(/\n\s*\n/g).map(function (p) { return p.trim(); }).filter(Boolean)
									.forEach(function (p) {
										blocks.push("<p>" + p.replace(/\n/g, "<br>") + "</p>");
									});
							}
						});
					}

					if (!blocks.length) {
						mockContent.innerHTML =
							"<p>This is a preview of your article layout. When you publish, your content will flow here with your selected hero image above.</p>" +
							"<p>You can use paragraphs, line breaks, and headings (later) to structure updates, release notes, roadmaps, and announcements.</p>";
						return;
					}

					mockContent.innerHTML = blocks.join("");
				}

				function syncContent() {
					renderCombinedContentForMock();
				}

				function syncTags() {
					if (!mockTags || !tagsInput) return;
					var raw = (tagsInput.value || "").trim();
					var tags = raw
						.split(",")
						.map(function (t) { return t.trim(); })
						.filter(Boolean)
						.slice(0, 8);

					if (!tags.length) {
						mockTags.innerHTML =
							'<span class="tag-pill">update</span><span class="tag-pill">release</span><span class="tag-pill">roadmap</span>';
						return;
					}

					mockTags.innerHTML = tags.map(function (t) {
						return '<span class="tag-pill">' + t + '</span>';
					}).join("");
				}

				function setHeroFile(file) {
					if (!file || !file.type || !file.type.startsWith("image/")) return;

					var reader = new FileReader();
					reader.onload = function () {
						var dataUrl = reader.result;
						drop.style.backgroundImage = "url('" + dataUrl + "')";
						hidden.value = dataUrl; // later: upload to Storage and save URL instead

						// âœ… also update mock hero background
						if (mockHero) {
							mockHero.style.backgroundImage = "url('" + dataUrl + "')";
						}
					};
					reader.readAsDataURL(file);
				}

				function insertBulletAtCursor(textarea) {
					if (!textarea) return;
					var bullet = "â€¢ ";
					var start = textarea.selectionStart || 0;
					var end = textarea.selectionEnd || 0;
					var value = textarea.value || "";

					var before = value.slice(0, start);
					var after = value.slice(end);

					var lastNewline = before.lastIndexOf("\n");
					var isLineStart = lastNewline === -1 || lastNewline === before.length - 1;

					var insertText = isLineStart ? bullet : "\n" + bullet;

					textarea.value = before + insertText + after;

					var newPos = before.length + insertText.length;
					textarea.selectionStart = textarea.selectionEnd = newPos;
					textarea.focus();

					textarea.dispatchEvent(new Event("input", { bubbles: true }));
				}

				function attachBulletButton(btn, textarea) {
					if (!btn || !textarea) return;
					btn.addEventListener("click", function () {
						insertBulletAtCursor(textarea);
					});
				}

				var sectionCount = 0;

				function addSection() {
					if (!sectionsContainer) return;
					sectionCount += 1;

					var wrapper = document.createElement("div");
					wrapper.className = "pp-section";
					wrapper.style.marginTop = "20px";

					var h = document.createElement("input");
					h.type = "text";
					h.name = "subheading_" + sectionCount;
					h.placeholder = "Subheading";

					var t = document.createElement("textarea");
					t.name = "section_" + sectionCount;
					t.placeholder = "Write your paragraph here...";
					t.rows = 6;

					var hWrap = document.createElement("div");
					hWrap.className = "col-12";
					hWrap.style.marginBottom = "20px"; // âœ… 20px gap between subheading and paragraph
					hWrap.appendChild(h);

					var tWrap = document.createElement("div");
					tWrap.className = "col-12";

					var bulletWrapper = document.createElement("div");
					bulletWrapper.className = "bullet-wrapper";

					var toolbar = document.createElement("div");
					toolbar.className = "bullet-toolbar";

					var btn = document.createElement("button");
					btn.type = "button";
					btn.className = "bullet-btn";
					btn.textContent = "â€¢";

					toolbar.appendChild(btn);
					bulletWrapper.appendChild(toolbar);
					bulletWrapper.appendChild(t);
					tWrap.appendChild(bulletWrapper);

					wrapper.appendChild(hWrap);
					wrapper.appendChild(tWrap);
					sectionsContainer.appendChild(wrapper);

					h.addEventListener("input", syncContent);
					t.addEventListener("input", syncContent);

					attachBulletButton(btn, t);

					syncContent();
				}

				titleInput.addEventListener("input", syncTitle);
				syncTitle();

				// âœ… attach bullet button for main content
				var mainBulletBtn = document.querySelector('.bullet-btn[data-bullet-for="content"]');
				attachBulletButton(mainBulletBtn, contentInput);

				mainSubheadingInput && mainSubheadingInput.addEventListener("input", syncContent);
				contentInput && contentInput.addEventListener("input", syncContent);
				tagsInput && tagsInput.addEventListener("input", syncTags);
				syncContent();
				syncTags();

				addSectionBtn && addSectionBtn.addEventListener("click", addSection);

				drop.addEventListener("click", function () {
					fileInput.click();
				});

				drop.addEventListener("keydown", function (e) {
					if (e.key === "Enter" || e.key === " ") {
						e.preventDefault();
						fileInput.click();
					}
				});

				fileInput.addEventListener("change", function () {
					setHeroFile(fileInput.files && fileInput.files[0]);
				});

				drop.addEventListener("dragover", function (e) {
					e.preventDefault();
					drop.classList.add("drag");
				});

				drop.addEventListener("dragleave", function () {
					drop.classList.remove("drag");
				});

				drop.addEventListener("drop", function (e) {
					e.preventDefault();
					drop.classList.remove("drag");
					var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
					setHeroFile(f);
				});

				/* âœ… Make Publish button exactly the same width as Save draft */
				var saveDraftBtn = document.querySelector('.articles-paragraph input[type="submit"][value="Save draft"]');
				var publishBtn = document.getElementById("publish-btn");
				if (saveDraftBtn && publishBtn) {
					publishBtn.style.width = saveDraftBtn.offsetWidth + "px";
				}
			})();
		</script>

		<!-- ðŸ” Admin guard + âœ… Publish + Edit logic -->
		<script type="module">
			import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
			import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
			import { getFirestore, doc, getDoc, collection, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

			const firebaseConfig = {
				apiKey: "AIzaSyBBOnsA7zbwoJ7sJFGIOuuJvpYWTHaBW4Q",
				authDomain: "pinpark-1fcb3.firebaseapp.com",
				projectId: "pinpark-1fcb3",
				storageBucket: "pinpark-1fcb3.firebasestorage.app",
				messagingSenderId: "677372487037",
				appId: "1:677372487037:web:5dcd5e788874aca5851814",
				measurementId: "G-LJN7NRFFX4"
			};

			const app  = initializeApp(firebaseConfig);
			const auth = getAuth(app);
			const db   = getFirestore(app);

			let currentArticleId = null;
			let nextSectionIndex = 1000; // for edit-created sections

			function getQueryParam(name) {
				try {
					const u = new URL(window.location.href);
					return u.searchParams.get(name);
				} catch (_) {
					return null;
				}
			}

			async function checkAdmin(user) {
				if (!user) return false;
				try {
					const snap = await getDoc(doc(db, "admins", user.uid));
					return snap.exists();
				} catch (e) {
					console.error("Admin check failed:", e);
					return false;
				}
			}

			function splitIntoParagraphs(raw) {
				return (raw || "")
					.trim()
					.split(/\n\s*\n/g)
					.map(p => p.trim())
					.filter(Boolean)
					.map(p => p.replace(/\\n/g, "<br>"));
			}

			function escapeHtml(str) {
				return (str || "")
					.replace(/&/g, "&amp;")
					.replace(/</g, "&lt;")
					.replace(/>/g, "&gt;")
					.replace(/"/g, "&quot;")
					.replace(/'/g, "&#039;");
			}

			function buildArticlePayload() {
				const titleInput = document.querySelector('input[name="title"]');
				const heroHidden = document.getElementById("heroImageDataUrl");
				const mainSubheadingInput = document.querySelector('input[name="subheading_main"]');
				const contentInput = document.querySelector('textarea[name="content"]');
				const tagsInput = document.querySelector('input[name="tags"]');
				const sectionsContainer = document.getElementById("sections-container");

				const title = (titleInput?.value || "").trim();
				const heroImageDataUrl = (heroHidden?.value || "").trim() || null;
				const mainSubheading = (mainSubheadingInput?.value || "").trim();
				const mainRaw = (contentInput?.value || "").trim();

				const tags = (tagsInput?.value || "")
					.split(",")
					.map(t => t.trim())
					.filter(Boolean)
					.slice(0, 12);

				// âœ… blocks = structured content you can render safely anywhere
				// types: "subheading" | "paragraph"
				const blocks = [];

				if (mainSubheading) blocks.push({ type: "subheading", text: mainSubheading });

				splitIntoParagraphs(mainRaw).forEach(pHtml => {
					blocks.push({ type: "paragraph", html: pHtml });
				});

				if (sectionsContainer) {
					const sectionEls = sectionsContainer.querySelectorAll(".pp-section");
					sectionEls.forEach(sec => {
						const h = sec.querySelector('input[name^="subheading_"]');
						const t = sec.querySelector('textarea[name^="section_"]');
						const heading = (h?.value || "").trim();
						const body = (t?.value || "").trim();

						if (heading) blocks.push({ type: "subheading", text: heading });

						splitIntoParagraphs(body).forEach(pHtml => {
							blocks.push({ type: "paragraph", html: pHtml });
						});
					});
				}

				// âœ… renderedHtml = ready-to-display HTML that matches the mock style
				const renderedHtml = blocks.map(b => {
					if (b.type === "subheading") {
						return `<h3 style="margin: 0 0 20px 0; color: #666;">${escapeHtml(b.text)}</h3>`;
					}
					return `<p>${b.html}</p>`;
				}).join("");

				return {
					title,
					heroImageDataUrl,
					tags,
					blocks,
					renderedHtml
				};
			}

			function refreshPreviewFromForm() {
				const payload = buildArticlePayload();

				const mockTitle = document.getElementById("mock-title");
				const mockContent = document.getElementById("mock-content");
				const mockTags = document.getElementById("mock-tags");

				if (mockTitle) {
					mockTitle.textContent = payload.title || "Your Article Title";
				}

				if (mockContent) {
					if (payload.renderedHtml && payload.renderedHtml.trim()) {
						mockContent.innerHTML = payload.renderedHtml;
					} else {
						mockContent.innerHTML =
							"<p>This is a preview of your article layout. When you publish, your content will flow here with your selected hero image above.</p>" +
							"<p>You can use paragraphs, line breaks, and headings (later) to structure updates, release notes, roadmaps, and announcements.</p>";
					}
				}

				if (mockTags) {
					if (payload.tags && payload.tags.length) {
						mockTags.innerHTML = payload.tags.map(t =>
							`<span class="tag-pill">${escapeHtml(t)}</span>`
						).join("");
					} else {
						mockTags.innerHTML =
							'<span class="tag-pill">update</span><span class="tag-pill">release</span><span class="tag-pill">roadmap</span>';
					}
				}
			}

			// âœ… now preserves any HTML (e.g. <ul>, <li>, <strong>) instead of stripping it
			function paragraphHtmlToTextarea(html) {
				if (!html) return "";
				let s = String(html);
				s = s.replace(/<br\s*\/?>/gi, "\n");
				return s;
			}

			function createSectionBlock(subheadingText, bodyText) {
				const sectionsContainer = document.getElementById("sections-container");
				if (!sectionsContainer) return;

				const wrapper = document.createElement("div");
				wrapper.className = "pp-section";
				wrapper.style.marginTop = "20px";

				const hWrap = document.createElement("div");
				hWrap.className = "col-12";
				hWrap.style.marginBottom = "20px";

				const tWrap = document.createElement("div");
				tWrap.className = "col-12";

				const idx = nextSectionIndex++;
				const hInput = document.createElement("input");
				hInput.type = "text";
				hInput.name = "subheading_" + idx;
				hInput.placeholder = "Subheading";
				hInput.value = subheadingText || "";

				const tArea = document.createElement("textarea");
				tArea.name = "section_" + idx;
				tArea.placeholder = "Write your paragraph here...";
				tArea.rows = 6;
				tArea.value = bodyText || "";

				const bulletWrapper = document.createElement("div");
				bulletWrapper.className = "bullet-wrapper";

				const toolbar = document.createElement("div");
				toolbar.className = "bullet-toolbar";

				const btn = document.createElement("button");
				btn.type = "button";
				btn.className = "bullet-btn";
				btn.textContent = "â€¢";

				toolbar.appendChild(btn);
				bulletWrapper.appendChild(toolbar);
				bulletWrapper.appendChild(tArea);
				tWrap.appendChild(bulletWrapper);

				hWrap.appendChild(hInput);
				wrapper.appendChild(hWrap);
				wrapper.appendChild(tWrap);
				sectionsContainer.appendChild(wrapper);

				hInput.addEventListener("input", refreshPreviewFromForm);
				tArea.addEventListener("input", refreshPreviewFromForm);

				btn.addEventListener("click", function () {
					const textarea = tArea;
					const bullet = "â€¢ ";
					const start = textarea.selectionStart || 0;
					const end = textarea.selectionEnd || 0;
					const value = textarea.value || "";
					const before = value.slice(0, start);
					const after = value.slice(end);
					const lastNewline = before.lastIndexOf("\n");
					const isLineStart = lastNewline === -1 || lastNewline === before.length - 1;
					const insertText = isLineStart ? bullet : "\n" + bullet;
					textarea.value = before + insertText + after;
					const newPos = before.length + insertText.length;
					textarea.selectionStart = textarea.selectionEnd = newPos;
					textarea.focus();
					textarea.dispatchEvent(new Event("input", { bubbles: true }));
				});
			}

			async function loadExistingArticle(articleId) {
				try {
					const ref = doc(db, "articles", articleId);
					const snap = await getDoc(ref);
					if (!snap.exists()) {
						console.warn("Article not found for edit:", articleId);
						return;
					}

					const data = snap.data() || {};

					const titleInput = document.querySelector('input[name="title"]');
					const mainSubheadingInput = document.querySelector('input[name="subheading_main"]');
					const contentInput = document.querySelector('textarea[name="content"]');
					const tagsInput = document.querySelector('input[name="tags"]');
					const heroHidden = document.getElementById("heroImageDataUrl");
					const heroDrop = document.getElementById("hero-drop");
					const mockHero = document.getElementById("mock-hero");
					const sectionsContainer = document.getElementById("sections-container");

					if (titleInput) {
						titleInput.value = data.title || "";
						// kick existing hero-title sync
						titleInput.dispatchEvent(new Event("input", { bubbles: true }));
					}

					if (tagsInput && Array.isArray(data.tags)) {
						tagsInput.value = data.tags.join(", ");
					}

					if (heroHidden) {
						const hero = data.heroImageDataUrl || "";
						heroHidden.value = hero;
						if (hero && heroDrop) {
							heroDrop.style.backgroundImage = `url('${hero}')`;
						}
						if (hero && mockHero) {
							mockHero.style.backgroundImage = `url('${hero}')`;
						}
					}

					// Rebuild content + sections from blocks if available
					const blocks = Array.isArray(data.blocks) ? data.blocks : null;

					let mainSubheading = "";
					let mainParagraphs = [];
					const sectionGroups = [];

					if (blocks && blocks.length) {
						let i = 0;

						if (blocks[0].type === "subheading") {
							mainSubheading = blocks[0].text || "";
							i = 1;
						}

						while (i < blocks.length && blocks[i].type === "paragraph") {
							mainParagraphs.push(paragraphHtmlToTextarea(blocks[i].html));
							i++;
						}

						while (i < blocks.length) {
							if (blocks[i].type !== "subheading") {
								// unexpected, treat as extra main paragraph
								if (blocks[i].type === "paragraph") {
									mainParagraphs.push(paragraphHtmlToTextarea(blocks[i].html));
								}
								i++;
								continue;
							}

							const heading = blocks[i].text || "";
							i++;
							const paras = [];

							while (i < blocks.length && blocks[i].type === "paragraph") {
								paras.push(paragraphHtmlToTextarea(blocks[i].html));
								i++;
							}

							sectionGroups.push({ subheading: heading, paragraphs: paras });
						}
					} else {
						// Fallback for older docs that only had renderedHtml
						const rendered = data.renderedHtml || "";
						const tmp = document.createElement("div");
						tmp.innerHTML = rendered;
						const ps = Array.from(tmp.querySelectorAll("p"));
						const paras = ps.map(p => (p.textContent || "").trim()).filter(Boolean);
						mainParagraphs = paras;
						mainSubheading = "";
					}

					if (mainSubheadingInput) {
						mainSubheadingInput.value = mainSubheading;
					}

					if (contentInput) {
						contentInput.value = mainParagraphs.join("\n\n");
					}

					if (sectionsContainer) {
						sectionsContainer.innerHTML = "";
						sectionGroups.forEach(group => {
							const bodyText = group.paragraphs.join("\n\n");
							createSectionBlock(group.subheading, bodyText);
						});
					}

					// Finally refresh the preview to match
					refreshPreviewFromForm();

					// If you want, you can also change the heading to "Edit Article"
					const heading = document.querySelector(".articles-under-logo h2");
					if (heading) heading.textContent = "Edit Article";
				} catch (e) {
					console.error("Failed to load existing article for edit:", e);
				}
			}

			async function publishArticle() {
				const btn = document.getElementById("publish-btn");
				if (btn) btn.disabled = true;

				try {
					const payload = buildArticlePayload();

					if (!payload.title) {
						alert("Please enter a title before publishing.");
						if (btn) btn.disabled = false;
						return;
					}

					if (!payload.blocks.length) {
						alert("Please write some content before publishing.");
						if (btn) btn.disabled = false;
						return;
					}

					if (currentArticleId) {
						// âœï¸ EDIT MODE: update existing doc
						const ref = doc(db, "articles", currentArticleId);
						const existingSnap = await getDoc(ref);
						const updateData = {
							title: payload.title,
							heroImageDataUrl: payload.heroImageDataUrl,
							tags: payload.tags,
							blocks: payload.blocks,
							renderedHtml: payload.renderedHtml,
							status: "published"
						};

						if (existingSnap.exists()) {
							const existing = existingSnap.data() || {};
							if (!existing.publishedAt) {
								updateData.publishedAt = serverTimestamp();
							}
							// keep existing createdAt if present
							if (!existing.createdAt) {
								updateData.createdAt = serverTimestamp();
							}
						} else {
							updateData.publishedAt = serverTimestamp();
							updateData.createdAt = serverTimestamp();
						}

						await updateDoc(ref, updateData);
					} else {
						// ðŸ†• CREATE MODE: new document
						await addDoc(collection(db, "articles"), {
							title: payload.title,
							heroImageDataUrl: payload.heroImageDataUrl,
							tags: payload.tags,
							blocks: payload.blocks,
							renderedHtml: payload.renderedHtml,
							status: "published",
							publishedAt: serverTimestamp(),
							createdAt: serverTimestamp()
						});
					}

					window.location.href = "articles_admin.html?section=current";
				} catch (e) {
					console.error("Publish failed:", e);
					alert("Publish failed: " + (e?.message || e));
					if (btn) btn.disabled = false;
				}
			}

			onAuthStateChanged(auth, async (user) => {
				const isAdmin = await checkAdmin(user);

				if (!isAdmin) {
					window.location.replace("articles.html");
					return;
				}

				// âœ… Admin confirmed -> reveal page
				document.documentElement.style.visibility = "visible";

				// Wire up preview to main fields as well (works for both create + edit)
				const titleInput = document.querySelector('input[name="title"]');
				const mainSubheadingInput = document.querySelector('input[name="subheading_main"]');
				const contentInput = document.querySelector('textarea[name="content"]');
				const tagsInput = document.querySelector('input[name="tags"]');

				titleInput && titleInput.addEventListener("input", refreshPreviewFromForm);
				mainSubheadingInput && mainSubheadingInput.addEventListener("input", refreshPreviewFromForm);
				contentInput && contentInput.addEventListener("input", refreshPreviewFromForm);
				tagsInput && tagsInput.addEventListener("input", refreshPreviewFromForm);

				// Check if we're editing an existing article
				currentArticleId = getQueryParam("articleId");
				if (currentArticleId) {
					await loadExistingArticle(currentArticleId);
				} else {
					// initial preview for fresh create
					refreshPreviewFromForm();
				}

				// âœ… hook up publish button now that we're verified
				const publishBtn = document.getElementById("publish-btn");
				if (publishBtn) {
					publishBtn.addEventListener("click", publishArticle);
				}
			});
		</script>

	</body>
</html>
